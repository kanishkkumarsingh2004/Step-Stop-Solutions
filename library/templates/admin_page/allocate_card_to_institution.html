{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-6 flex flex-col justify-center sm:py-12">
    <div class="relative py-3 sm:max-w-xl sm:mx-auto">
        <div class="relative px-4 py-10 bg-white mx-8 md:mx-0 shadow rounded-3xl sm:p-10">
            <div class="max-w-md mx-auto">
                <div class="divide-y divide-gray-200">
                    <div class="py-8 text-base leading-6 space-y-4 text-gray-700 sm:text-lg sm:leading-7">
                        <h2 class="text-2xl font-bold mb-8 text-center text-gray-900">Allocate Cards to Institution</h2>
                        
                        <form id="allocateForm" class="space-y-6">
                            {% csrf_token %}
                            <div>
                                <label for="institution" class="block text-sm font-medium text-gray-700">Select Institution</label>
                                <select id="institution" name="institution" required class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                    <option value="">Select an institution</option>
                                    {% for institution in institutions %}
                                    <option value="{{ institution.id }}">{{ institution.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="mt-6">
                                <h3 class="text-lg font-medium text-gray-900 mb-4">Available Cards</h3>
                                <div class="bg-gray-50 p-4 rounded-lg">
                                    <div class="text-sm text-gray-500 mb-4">
                                        Tap an NFC card to select it, or manually select cards using checkboxes
                                    </div>
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Card ID</th>
                                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    <input type="checkbox" id="select-all" class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200">
                                            {% for card in admin_cards %}
                                            <tr>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600">
                                                    <label for="card-{{ card.id }}">{{ card.card_id }}</label>
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    <input type="checkbox" name="nfc_serials" value="{{ card.card_id }}" id="card-{{ card.id }}" class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <div class="pt-5">
                                <div class="flex justify-end">
                                    <button type="submit" class="ml-3 inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                        Allocate Selected Cards
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('allocateForm');
    const selectAllCheckbox = document.getElementById('select-all');
    const cardCheckboxes = document.querySelectorAll('input[name="nfc_serials"]');
    let isNFCReading = false;

    // Handle select all checkbox
    selectAllCheckbox.addEventListener('change', function() {
        cardCheckboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
    });

    // Function to handle NFC card tap
    async function handleNFCTap(nfcSerial) {
        if (isNFCReading) return;
        isNFCReading = true;

        try {
            // Find the checkbox for the tapped card
            const checkbox = document.querySelector(`input[value="${nfcSerial}"]`);
            if (checkbox) {
                // Toggle the checkbox
                checkbox.checked = !checkbox.checked;
                
                // Visual feedback
                const row = checkbox.closest('tr');
                row.style.backgroundColor = checkbox.checked ? '#E8F0FE' : '';
                
                // Add a temporary highlight effect
                row.style.transition = 'background-color 0.3s';
                setTimeout(() => {
                    row.style.backgroundColor = '';
                }, 1000);
            }
        } catch (error) {
            console.error('Error handling NFC tap:', error);
        } finally {
            isNFCReading = false;
        }
    }

    // Listen for NFC card taps
    if ('NDEFReader' in window) {
        const ndef = new NDEFReader();
        
        ndef.addEventListener('reading', ({ message }) => {
            const decoder = new TextDecoder();
            for (const record of message.records) {
                const nfcSerial = decoder.decode(record.data);
                handleNFCTap(nfcSerial);
            }
        });

        ndef.scan().catch(error => {
            console.error('Error starting NFC scan:', error);
        });
    } else {
        console.log('Web NFC is not supported in this browser');
    }

    // Handle form submission
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const institutionId = document.getElementById('institution').value;
        const selectedCards = Array.from(cardCheckboxes)
            .filter(cb => cb.checked)
            .map(cb => cb.value);

        if (!institutionId) {
            alert('Please select an institution');
            return;
        }

        if (selectedCards.length === 0) {
            alert('Please select at least one card');
            return;
        }

        try {
            const response = await fetch('{% url "allocate_card_to_institution" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    institution_id: institutionId,
                    nfc_serials: selectedCards
                })
            });

            const data = await response.json();
            
            if (response.ok) {
                alert('Cards allocated successfully!');
                window.location.reload();
            } else {
                alert(data.error || 'Failed to allocate cards');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('An error occurred while allocating cards');
        }
    });
});
</script>
{% endblock %} 