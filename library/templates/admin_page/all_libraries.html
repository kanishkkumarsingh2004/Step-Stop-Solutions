{% extends "base.html" %}
{% load static %}

{% block extra_js %}
<script src="{% static 'js/library_subscription.js' %}"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-2 sm:px-4 lg:px-8 py-4 sm:py-8">
    {% csrf_token %}
    <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 mb-6">All Libraries</h1>
    <div class="bg-white p-4 sm:p-6 rounded-lg shadow-sm overflow-x-auto">
        <div class="block sm:hidden">
            <!-- Mobile View -->
            <div class="space-y-4">
                {% for library in libraries %}
                <div class="p-4 border rounded-lg">
                    <div class="space-y-2">
                        <div>
                            <span class="text-sm font-medium text-gray-500">Name:</span>
                            <span class="text-sm text-gray-900">{{ library.venue_name }}</span>
                        </div>
                        <div>
                            <span class="text-sm font-medium text-gray-500">Owner:</span>
                            <span class="text-sm text-gray-900">{{ library.owner.get_full_name }}</span>
                        </div>
                        <div>
                            <span class="text-sm font-medium text-gray-500">Subscription Period:</span>
                            <div class="mt-1 flex flex-col space-y-2">
                                <input type="date" 
                                       data-library-id="{{ library.id }}"
                                       data-field="start"
                                       class="subscription-date border rounded p-1 w-full"
                                       value="{{ library.subscription_start_date|date:'Y-m-d' }}">
                                <input type="date" 
                                       data-library-id="{{ library.id }}"
                                       data-field="end"
                                       class="subscription-date border rounded p-1 w-full"
                                       value="{{ library.subscription_end_date|date:'Y-m-d' }}">
                            </div>
                        </div>
                        <div>
                            <span class="text-sm font-medium text-gray-500">Status:</span>
                            <span class="px-2 py-1 text-xs font-semibold rounded-full {% if library.is_approved %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
                                {% if library.is_approved %}Approved{% else %}Pending{% endif %}
                            </span>
                        </div>
                        <div>
                            <a href="{% url 'admin_full_info_library_details' library.id %}" class="text-blue-600 hover:text-blue-900 text-sm">
                                View Details
                            </a>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        <div class="hidden sm:block">
            <!-- Desktop View -->
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-3 py-2 sm:px-6 sm:py-3 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
                        <th class="px-3 py-2 sm:px-6 sm:py-3 text-left text-xs font-medium text-gray-500 uppercase">Owner</th>
                        <th class="px-3 py-2 sm:px-6 sm:py-3 text-left text-xs font-medium text-gray-500 uppercase">Start Date</th>
                        <th class="px-3 py-2 sm:px-6 sm:py-3 text-left text-xs font-medium text-gray-500 uppercase">End Date</th>
                        <th class="px-3 py-2 sm:px-6 sm:py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                        <th class="px-3 py-2 sm:px-6 sm:py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for library in libraries %}
                    <tr>
                        <td class="px-3 py-2 sm:px-6 sm:py-3 text-sm text-gray-900">{{ library.venue_name }}</td>
                        <td class="px-3 py-2 sm:px-6 sm:py-3 text-sm text-gray-900">{{ library.owner.get_full_name }}</td>
                        <td class="px-3 py-2 sm:px-6 sm:py-3 text-sm text-gray-900">
                            <input type="date" 
                                   data-library-id="{{ library.id }}"
                                   data-field="start"
                                   class="subscription-date border rounded p-1"
                                   value="{% if library.subscription_start_date %}{{ library.subscription_start_date|date:'Y-m-d' }}{% endif %}">
                        </td>
                        <td class="px-3 py-2 sm:px-6 sm:py-3 text-sm text-gray-900">
                            <input type="date" 
                                   data-library-id="{{ library.id }}"
                                   data-field="end"
                                   class="subscription-date border rounded p-1"
                                   value="{% if library.subscription_end_date %}{{ library.subscription_end_date|date:'Y-m-d' }}{% endif %}">
                        </td>
                        <td class="px-3 py-2 sm:px-6 sm:py-3 text-sm text-gray-900">
                            <span class="px-2 py-1 text-xs font-semibold rounded-full {% if library.is_approved %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
                                {% if library.is_approved %}Approved{% else %}Pending{% endif %}
                            </span>
                        </td>
                        <td class="px-3 py-2 sm:px-6 sm:py-3 text-sm text-gray-900">
                            <a href="{% url 'admin_full_info_library_details' library.id %}" class="text-blue-600 hover:text-blue-900 text-xs">
                                View Details
                            </a>                    
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const toastMessage = document.getElementById('toast-message');
    const toastText = document.getElementById('toast-text');

    function showToast(message, isError = false) {
        toastText.textContent = message;
        toastMessage.classList.remove('translate-y-[-100%]', 'opacity-0');
        toastMessage.classList.add('translate-y-0', 'opacity-100');
        
        if (isError) {
            toastMessage.classList.remove('bg-green-500');
            toastMessage.classList.add('bg-red-500');
        } else {
            toastMessage.classList.remove('bg-red-500');
            toastMessage.classList.add('bg-green-500');
        }

        setTimeout(() => {
            toastMessage.classList.remove('translate-y-0', 'opacity-100');
            toastMessage.classList.add('translate-y-[-100%]', 'opacity-0');
        }, 3000);
    }
    
    document.querySelectorAll('.subscription-date').forEach(input => {
        // Store initial values when page loads
        input.setAttribute('data-original-value', input.value);

        input.addEventListener('blur', async function() {
            const libraryId = this.dataset.libraryId;
            const field = this.dataset.field;
            const value = this.value;
            const originalValue = this.getAttribute('data-original-value');
            
            if (value === originalValue) {
                return; // No change, don't make an API call
            }

            try {
                // Show loading state
                input.disabled = true;
                
                const response = await fetch('/update_library_subscription/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({
                        library_id: libraryId,
                        field: field,
                        value: value
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // Update was successful
                    this.setAttribute('data-original-value', value);
                    
                    const fieldName = field === 'start' ? 'Start Date' : 'End Date';
                    // Show success message using SweetAlert2
                    Swal.fire({
                        icon: 'success',
                        title: 'Date Updated!',
                        text: `${fieldName} has been successfully updated`,
                        showConfirmButton: false,
                        timer: 1500,
                        position: 'top-end',
                        toast: true,
                        background: '#a7f3d0',
                        iconColor: '#059669'
                    });
                } else {
                    throw new Error(data.error || 'Update failed');
                }
            } catch (error) {
                console.error('Error:', error);
                // Revert to original value on error
                this.value = originalValue || '';
                // Show error message using SweetAlert2
                Swal.fire({
                    icon: 'error',
                    title: 'Error!',
                    text: `Error updating date: ${error.message}`,
                    showConfirmButton: true,
                    position: 'top-end',
                    toast: true,
                    background: '#fee2e2',
                    iconColor: '#dc2626'
                });
            } finally {
                // Remove loading state
                input.disabled = false;
            }
        });
    });
});
</script>

{% endblock %}