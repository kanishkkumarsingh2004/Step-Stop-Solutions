{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="max-w-7xl mx-auto px-2 sm:px-4 lg:px-8 py-4 sm:py-8">
    {% csrf_token %}
    <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 mb-6">All Libraries</h1>
    <div class="bg-white p-4 sm:p-6 rounded-lg shadow-sm overflow-x-auto">
        <div class="block sm:hidden">
            <!-- Mobile View -->
            <div class="space-y-4">
                {% for library in libraries %}
                <div class="p-4 border rounded-lg">
                    <div class="space-y-2">
                        <div>
                            <span class="text-sm font-medium text-gray-500">Name:</span>
                            <span class="text-sm text-gray-900">{{ library.venue_name }}</span>
                        </div>
                        <div>
                            <span class="text-sm font-medium text-gray-500">Owner:</span>
                            <span class="text-sm text-gray-900">{{ library.owner.get_full_name }}</span>
                        </div>
                        <div>
                            <span class="text-sm font-medium text-gray-500">Subscription Period:</span>
                            <div class="mt-1 flex flex-col space-y-2">
                                <input type="date" 
                                       data-library-id="{{ library.id }}"
                                       data-field="start"
                                       class="subscription-date border rounded p-1 w-full"
                                       value="{{ library.subscription_start_date|date:'Y-m-d' }}">
                                <input type="date" 
                                       data-library-id="{{ library.id }}"
                                       data-field="end"
                                       class="subscription-date border rounded p-1 w-full"
                                       value="{{ library.subscription_end_date|date:'Y-m-d' }}">
                            </div>
                        </div>
                        <div>
                            <span class="text-sm font-medium text-gray-500">Status:</span>
                            <span class="px-2 py-1 text-xs font-semibold rounded-full {% if library.is_approved %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
                                {% if library.is_approved %}Approved{% else %}Pending{% endif %}
                            </span>
                        </div>
                        <div>
                            <a href="{% url 'admin_full_info_library_details' library.id %}" class="text-blue-600 hover:text-blue-900 text-sm">
                                View Details
                            </a>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        <div class="hidden sm:block">
            <!-- Desktop View -->
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-3 py-2 sm:px-6 sm:py-3 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
                        <th class="px-3 py-2 sm:px-6 sm:py-3 text-left text-xs font-medium text-gray-500 uppercase">Owner</th>
                        <th class="px-3 py-2 sm:px-6 sm:py-3 text-left text-xs font-medium text-gray-500 uppercase">Start Date</th>
                        <th class="px-3 py-2 sm:px-6 sm:py-3 text-left text-xs font-medium text-gray-500 uppercase">End Date</th>
                        <th class="px-3 py-2 sm:px-6 sm:py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                        <th class="px-3 py-2 sm:px-6 sm:py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for library in libraries %}
                    <tr>
                        <td class="px-3 py-2 sm:px-6 sm:py-3 text-sm text-gray-900">{{ library.venue_name }}</td>
                        <td class="px-3 py-2 sm:px-6 sm:py-3 text-sm text-gray-900">{{ library.owner.get_full_name }}</td>
                        <td class="px-3 py-2 sm:px-6 sm:py-3 text-sm text-gray-900">
                            <input type="date" 
                                   data-library-id="{{ library.id }}"
                                   data-field="start"
                                   class="subscription-date border rounded p-1"
                                   value="{% if library.subscription_start_date %}{{ library.subscription_start_date|date:'Y-m-d' }}{% endif %}">
                        </td>
                        <td class="px-3 py-2 sm:px-6 sm:py-3 text-sm text-gray-900">
                            <input type="date" 
                                   data-library-id="{{ library.id }}"
                                   data-field="end"
                                   class="subscription-date border rounded p-1"
                                   value="{% if library.subscription_end_date %}{{ library.subscription_end_date|date:'Y-m-d' }}{% endif %}">
                        </td>
                        <td class="px-3 py-2 sm:px-6 sm:py-3 text-sm text-gray-900">
                            <span class="px-2 py-1 text-xs font-semibold rounded-full {% if library.is_approved %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
                                {% if library.is_approved %}Approved{% else %}Pending{% endif %}
                            </span>
                        </td>
                        <td class="px-3 py-2 sm:px-6 sm:py-3 text-sm text-gray-900">
                            <a href="{% url 'admin_full_info_library_details' library.id %}" class="text-blue-600 hover:text-blue-900 text-xs">
                                View Details
                            </a>                    
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    // Store original values for all date inputs
    document.querySelectorAll('.subscription-date').forEach(input => {
        input.setAttribute('data-original-value', input.value);

        input.addEventListener('change', function() {
            const originalValue = this.getAttribute('data-original-value');
            const newValue = this.value;
            const field = this.dataset.field;
            const fieldName = field === 'start' ? 'Start Date' : 'End Date';

            if (newValue === originalValue) {
                return;
            }

            // Show confirmation dialog before making the change
            Swal.fire({
                title: `Change ${fieldName}?`,
                text: `Are you sure you want to change the ${fieldName.toLowerCase()} from "${originalValue || 'empty'}" to "${newValue || 'empty'}"?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#059669',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, change it',
                cancelButtonText: 'Cancel'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    // Proceed with update
                    this.disabled = true;
                    try {
                        const response = await fetch('/update_library_subscription/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': csrfToken
                            },
                            body: JSON.stringify({
                                library_id: this.dataset.libraryId,
                                field: field,
                                value: newValue
                            })
                        });

                        const data = await response.json();

                        if (data.success) {
                            this.setAttribute('data-original-value', newValue);
                            Swal.fire({
                                icon: 'success',
                                title: 'Date Updated!',
                                text: `${fieldName} has been successfully updated`,
                                showConfirmButton: false,
                                timer: 1500,
                                position: 'top-end',
                                toast: true,
                                background: '#a7f3d0',
                                iconColor: '#059669'
                            });
                        } else {
                            throw new Error(data.error || 'Update failed');
                        }
                    } catch (error) {
                        this.value = originalValue || '';
                        Swal.fire({
                            icon: 'error',
                            title: 'Error!',
                            text: `Error updating date: ${error.message}`,
                            showConfirmButton: true,
                            position: 'top-end',
                            toast: true,
                            background: '#fee2e2',
                            iconColor: '#dc2626'
                        });
                    } finally {
                        this.disabled = false;
                    }
                } else {
                    // Revert to original value if cancelled
                    this.value = originalValue || '';
                }
            });
        });
    });
});
</script>

{% endblock %}