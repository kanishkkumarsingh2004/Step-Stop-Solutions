{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="max-w-2xl mx-auto bg-white rounded-xl shadow-lg p-8">
        <h1 class="text-2xl sm:text-3xl font-bold text-blue-800 mb-6 text-center">Allocate Student Card</h1>

        <div id="message-container" class="mb-4"></div>

        <form id="allocate-card-form" class="space-y-6">
            {% csrf_token %}
            <input type="hidden" name="institution_uid" value="{{ institution.uid }}">

            <div>
                <label for="card_id" class="block text-sm font-medium text-gray-700 mb-2">1. Scan Card</label>
                <div class="flex items-center space-x-4">
                    <input type="text" id="card_id" name="card_id" disabled class="flex-grow w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Card ID will appear here" required>
                    <button type="button" id="scan-nfc-button" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 flex items-center space-x-2">
                        <i class="bi bi-wifi"></i>
                        <span>Scan NFC</span>
                    </button>
                </div>
                <p id="nfc-status" class="text-xs text-gray-500 mt-1">Click "Scan NFC" and tap the card on your device.</p>
            </div>

            <div>
                <label for="user_id" class="block text-sm font-medium text-gray-700 mb-2">2. Select Student</label>
                <select id="user_id" name="user_id" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                    <option value="" disabled selected>-- Select a student --</option>
                    {% for item in users_with_status %}
                        <option value="{{ item.user.id }}" {% if item.has_card %}disabled{% endif %}>
                            {{ item.user.get_full_name }} - {{ item.user.mobile_number }}
                            {% if item.has_card %} (Card Allocated){% endif %}
                            {% if not item.has_active_subscription %} (Inactive Subscription){% endif %}
                        </option>
                    {% empty %}
                        <option value="" disabled>No students found.</option>
                    {% endfor %}
                </select>
            </div>

            <div class="flex justify-end pt-4">
                <button type="submit" id="submit-button" class="px-6 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    Allocate Card
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const cardIdInput = document.getElementById('card_id');
    const nfcStatus = document.getElementById('nfc-status');
    const scanNfcButton = document.getElementById('scan-nfc-button');
    const messageContainer = document.getElementById('message-container');
    const allocateForm = document.getElementById('allocate-card-form');
    const submitButton = document.getElementById('submit-button');

    if ('NDEFReader' in window) {
        scanNfcButton.addEventListener('click', async () => {
            nfcStatus.textContent = 'NFC scanner activated. Please tap your card.';
            nfcStatus.className = 'text-xs text-blue-600 mt-1';
            
            try {
                const nfcReader = new NDEFReader();
                await nfcReader.scan();

                nfcReader.onreading = event => {
                    const serialNumber = event.serialNumber;
                    const formattedId = serialNumber.trim().toUpperCase();
                    cardIdInput.value = formattedId;
                    nfcStatus.textContent = `Success! Scanned card: ${formattedId}`;
                    nfcStatus.className = 'text-xs text-green-600 mt-1';
                };

                nfcReader.onerror = (event) => {
                    nfcStatus.textContent = 'Cannot read NFC card. Please try again. ' + event.message;
                    nfcStatus.className = 'text-xs text-red-600 mt-1';
                };

            } catch (error) {
                nfcStatus.textContent = `Error: ${error.message}`;
                nfcStatus.className = 'text-xs text-red-600 mt-1';
            }
        });
    } else {
        nfcStatus.textContent = 'Web NFC is not supported on this device. Please enter Card ID manually.';
        scanNfcButton.disabled = true;
        scanNfcButton.classList.add('opacity-50', 'cursor-not-allowed');
    }

    allocateForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(allocateForm);
        const data = {
            card_id: formData.get('card_id').trim().toUpperCase(),
            user_id: formData.get('user_id'),
            institution_uid: formData.get('institution_uid')
        };
        
        if (!data.card_id || !data.user_id) {
            displayMessage('error', 'Please provide a card ID and select a student.');
            return;
        }

        submitButton.disabled = true;
        submitButton.textContent = 'Allocating...';

        fetch("{% url 'allocate_card_to_institution_action' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': formData.get('csrfmiddlewaretoken')
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            displayMessage(result.status, result.message);

            if (result.status === 'success') {
                allocateForm.reset();
                nfcStatus.textContent = 'Click "Scan NFC" and tap the card on your device.';
                nfcStatus.className = 'text-xs text-gray-500 mt-1';
                const userSelect = document.getElementById('user_id');
                const optionToRemove = userSelect.querySelector(`option[value="${data.user_id}"]`);
                if(optionToRemove) {
                    optionToRemove.remove();
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            displayMessage('error', 'An unexpected network error occurred. Please check your connection and try again.');
        })
        .finally(() => {
            submitButton.disabled = false;
            submitButton.textContent = 'Allocate Card';
        });
    });

    function displayMessage(status, message) {
        let messageDivClass = status === 'success' 
            ? 'bg-green-100 text-green-700' 
            : 'bg-red-100 text-red-700';
        
        const messageDiv = `<div class="p-4 text-sm rounded-lg ${messageDivClass}" role="alert">${message}</div>`;
        messageContainer.innerHTML = messageDiv;

        setTimeout(() => {
            if (messageContainer.innerHTML.includes(message)) {
                messageContainer.innerHTML = '';
            }
        }, 5000);
    }
});
</script>
{% endblock %}