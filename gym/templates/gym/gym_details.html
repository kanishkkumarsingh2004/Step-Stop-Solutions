{% extends "base.html" %}

{% block content %}
<style>
    /* Enhanced star styles for display and form */
    .star-rating {
        display: flex;
        flex-direction: row;
        gap: 0.15em;
        font-size: 1.5rem;
        line-height: 1;
    }
    .star-rating .star {
        color: #fbbf24; /* Tailwind yellow-400 */
        transition: color 0.15s;
        margin-right: 0.1em;
        display: inline-block;
        vertical-align: middle;
    }
    .star-rating .star.empty {
        color: #d1d5db; /* Tailwind gray-300 */
    }
    /* Styles for the review form stars */
    .stars-form {
        display: flex;
        flex-direction: row;
        justify-content: flex-start;
        gap: 0.10em;
        font-size: 2rem;
        cursor: pointer;
    }
    .stars-form label {
        color: #d1d5db;
        transition: color 0.18s;
        cursor: pointer;
        padding: 0 2px;
        user-select: none;
    }
    .stars-form label.hovered,
    .stars-form label.selected {
        color: #fbbf24;
        text-shadow: 0 0 2px #fbbf24;
    }
    .stars-form input[type="radio"] {
        display: none;
    }
</style>
<div class="container mx-auto py-8 px-4">
    <div class="bg-white rounded-xl shadow-lg overflow-hidden mb-8">
        <!-- Gym Header -->
        <div class="bg-gradient-to-r from-blue-200 to-blue-100 px-8 py-6 flex flex-col md:flex-row gap-6 items-center justify-between border-b border-blue-200">
            <div class="flex flex-col gap-2">
                <h1 class="text-3xl font-extrabold text-gray-900">{{ gym.venue_name }}</h1>
                <span class="inline-block px-4 py-1 rounded-full {% if gym.business_type == "Library" %}bg-blue-200 text-blue-700{% else %}bg-green-200 text-green-700{% endif %} text-sm font-semibold">
                    {{ gym.business_type|default:"Gym" }}
                </span>
            </div>
            <!-- Gym Image (optional: replace placeholder SVG if image field exists) -->
            <div class="w-28 h-28 bg-gray-100 rounded-lg border-4 border-white shadow flex items-center justify-center overflow-hidden">
                {% if gym.image %}
                    <img src="{{ gym.image.url }}" alt="{{ gym.venue_name }}" class="object-cover w-full h-full" />
                {% else %}
                    <svg class="w-16 h-16 text-gray-300" fill="none" viewBox="0 0 24 24">
                        <path d="M4 16L8.586 11.414C8.961 11.039 9.47 10.828 10 10.828C10.53 10.828 11.039 11.039 11.414 11.414L16 16M14 14L15.586 12.414C15.961 12.039 16.47 11.828 17 11.828C17.53 11.828 18.039 12.039 18.414 12.414L20 14M14 8H14.01M6 20H18C19.1046 20 20 19.1046 20 18V6C20 4.89543 19.1046 4 18 4H6C4.89543 4 4 4.89543 4 6V18C4 19.1046 4.89543 20 6 20Z"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"/>
                    </svg>
                {% endif %}
            </div>
        </div>

        <!-- Main Info Section -->
        <div class="p-8 grid gap-8">
            <!-- About the Gym -->
            <div class="bg-gradient-to-br from-gray-50 to-white rounded-xl p-6 shadow">
                <h2 class="text-2xl font-bold text-gray-800 mb-2">About Us</h2>
                <p class="text-gray-700 text-lg">{{ gym.description|linebreaks }}</p>
            </div>

            <!-- Details Grid -->
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">
                <div class="bg-white rounded-xl border shadow p-5">
                    <h3 class="font-semibold text-lg mb-1">üìç Location</h3>
                    <div class="text-gray-600">{{ gym.venue_location }}</div>
                </div>
                <div class="bg-white rounded-xl border shadow p-5">
                    <h3 class="font-semibold text-lg mb-1">üïí Business Hours</h3>
                    <div class="text-gray-600">{{ gym.opening_time|time:"H:i" }} - {{ gym.closing_time|time:"H:i" }}</div>
                </div>
                <div class="bg-white rounded-xl border shadow p-5">
                    <h3 class="font-semibold text-lg mb-1">üë• Capacity</h3>
                    <div class="text-gray-600">{{ gym.capacity }} people</div>
                </div>
            </div>

            {% if gym.equipment_available %}
            <div class="bg-white rounded-xl shadow p-6 border">
                <h3 class="text-xl font-bold text-gray-800 mb-2">üõ†Ô∏è Equipment Available</h3>
                <div class="text-gray-700">{{ gym.equipment_available|linebreaks }}</div>
            </div>
            {% endif %}

            {% if gym.additional_services %}
            <div class="bg-white rounded-xl shadow p-6 border">
                <h3 class="text-xl font-bold text-gray-800 mb-2">‚ú® Additional Services</h3>
                <div class="text-gray-700">{{ gym.additional_services|linebreaks }}</div>
            </div>
            {% endif %}

            <!-- Reviews Section -->
            <div class="bg-white rounded-xl shadow p-6 border">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-4">
                    <h2 class="text-2xl font-bold flex items-center gap-2">
                        <span>üåü Reviews</span>
                    </h2>
                    <div class="flex flex-col sm:flex-row items-start sm:items-center gap-2">
                        <span class="star-rating font-semibold">
                            {% for i in "12345" %}
                                {% if i|add:0 <= gym.average_rating|floatformat:0|add:0 %}
                                    <span class="star">&#9733;</span>
                                {% else %}
                                    <span class="star empty">&#9733;</span>
                                {% endif %}
                            {% endfor %}
                            <span class="ml-2 text-gray-700 text-sm font-normal">{{ gym.average_rating|default:"0.0" }} ({{ reviews.count }})</span>
                        </span>
                        {% if user.is_authenticated %}
                            {% if user_has_reviewed %}
                                <span class="ml-3 text-green-700 text-sm bg-green-100 rounded px-2 py-1">Thank you for your review!</span>
                            {% else %}
                                <!-- Trigger Button for Popup Modal -->
                                <button type="button"
                                    id="openReviewModalBtn"
                                    class="ml-3 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition">
                                    Add Review
                                </button>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
                <div class="space-y-4">
                    {% for review in reviews %}
                    <div class="bg-gray-50 rounded p-4">
                        <div class="flex items-start justify-between gap-2 mb-1">
                            <div class="flex items-center gap-2">
                                <span class="star-rating">
                                    {% for i in "12345" %}
                                        {% if forloop.counter <= review.rating %}
                                            <span class="star">&#9733;</span>
                                        {% else %}
                                            <span class="star empty">&#9733;</span>
                                        {% endif %}
                                    {% endfor %}
                                </span>
                                <span class="text-gray-700 text-sm font-semibold">{{ review.user.get_full_name }}</span>
                            </div>
                            <span class="text-xs text-gray-500 whitespace-nowrap">{{ review.created_at|date:"M d, Y" }}</span>
                        </div>
                        {% if review.comment %}
                        <div class="text-gray-700 text-sm mt-1">{{ review.comment }}</div>
                        {% endif %}
                    </div>
                    {% empty %}
                    <p class="text-gray-500">No reviews yet. Be the first to review!</p>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Contact Info -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 border-t bg-gray-50 py-8 px-8">
            <div class="bg-white p-6 rounded-xl shadow">
                <h3 class="font-semibold mb-2 text-lg">üìû Contact Us</h3>
                <div class="text-gray-700">{{ gym.mobile_number }}</div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow">
                <h3 class="font-semibold mb-2 text-lg">‚úâÔ∏è Email</h3>
                <div class="text-gray-700">{{ gym.email }}</div>
            </div>
        </div>

        <!-- Footer Actions -->
        <div class="border-t px-8 py-6 bg-white rounded-b-xl flex flex-col sm:flex-row gap-4 items-stretch sm:items-center justify-between">
            <a href="{% url 'browse_gyms' %}" class="flex items-center justify-center bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition font-semibold shadow">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                </svg>
                Back to Gyms
            </a>
            <a href="{% url 'gym_subscription' gym.id %}" class="flex items-center justify-center bg-green-600 text-white px-8 py-3 rounded-lg hover:bg-green-700 transition font-semibold shadow">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                </svg>
                Explore Subscriptions
            </a>
        </div>
    </div>
</div>

<!-- Review Modal Popup -->
<div id="customReviewModal" class="fixed inset-0 z-50 bg-black bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-white rounded-lg shadow-lg max-w-md w-full mx-2">
        <form method="post" action="">
            {% csrf_token %}
            <div class="flex justify-between items-center border-b px-6 py-4">
                <h3 class="text-lg font-semibold" id="reviewModalLabel">Leave a Review</h3>
                <button type="button" class="text-2xl text-gray-400 hover:text-gray-600" id="closeReviewModalBtn">&times;</button>
            </div>
            <div class="px-6 py-4">
                {% if form.non_field_errors %}
                    <div class="bg-red-100 text-red-700 rounded px-3 py-2 mb-3">
                        {{ form.non_field_errors }}
                    </div>
                {% endif %}
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-1">Rating</label>
                    <div>
                        {% if form.rating.errors %}
                            <div class="text-red-500 text-xs mt-1">{{ form.rating.errors }}</div>
                        {% endif %}
                        <!-- Inline star rating: radio buttons styled as stars -->
                        <div class="stars-form">
                            {% for i in "12345" %}
                                <input type="radio"
                                       id="star{{ i }}"
                                       name="{{ form.rating.html_name }}"
                                       value="{{ i }}"
                                       {% if form.rating.value|stringformat:"s" == i %}checked{% endif %}
                                />
                                <label for="star{{ i }}" title="{{ i }} star{% if i != '1' %}s{% endif %}">&#9733;</label>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                <div class="mb-4">
                    <label for="{{ form.comment.id_for_label }}" class="block text-sm font-medium mb-1">Comment</label>
                    <div>
                        {% if form.comment.errors %}
                            <div class="text-red-500 text-xs mt-1">{{ form.comment.errors }}</div>
                        {% endif %}
                        {{ form.comment }}
                    </div>
                </div>
            </div>
            <div class="flex gap-3 justify-end border-t px-6 py-4">
                <button type="button" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-5 py-2 rounded" id="closeReviewModalBtn2">Cancel</button>
                <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded">Submit Review</button>
            </div>
        </form>
    </div>
</div>

<script>
    // Enhanced star styling for review modal
    document.addEventListener('DOMContentLoaded', function() {
        var openBtn = document.getElementById('openReviewModalBtn');
        var modal = document.getElementById('customReviewModal');
        var closeBtn = document.getElementById('closeReviewModalBtn');
        var closeBtn2 = document.getElementById('closeReviewModalBtn2');

        function showModal() {
            modal.classList.remove('hidden');
        }
        function hideModal() {
            modal.classList.add('hidden');
        }

        if (openBtn) {
            openBtn.addEventListener('click', showModal);
        }
        if (closeBtn) {
            closeBtn.addEventListener('click', hideModal);
        }
        if (closeBtn2) {
            closeBtn2.addEventListener('click', hideModal);
        }

        // Optional: Close modal when clicking outside of the modal content
        modal && modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                hideModal();
            }
        });

        // Enhanced star rating interactions
        const starsForm = document.querySelector('.stars-form');
        if (starsForm) {
            const radioStars = starsForm.querySelectorAll('input[type="radio"]');
            const starLabels = Array.from(starsForm.querySelectorAll('label'));
            // Highlight checked stars initially
            function syncCheckedStars() {
                let checkedIdx = -1;
                radioStars.forEach((radio, idx) => {
                    if (radio.checked) checkedIdx = idx;
                });
                // For left-to-right order
                starLabels.forEach((label, idx) => {
                    label.classList.toggle('selected', idx <= checkedIdx && checkedIdx !== -1);
                });
            }
            syncCheckedStars();

            starLabels.forEach((label, idx) => {
                label.addEventListener('mouseenter', () => {
                    starLabels.forEach((l, i) => {
                        if (i <= idx) {
                            l.classList.add('hovered');
                        }
                    });
                });
                label.addEventListener('mouseleave', () => {
                    starLabels.forEach((l) => l.classList.remove('hovered'));
                });
            });
            radioStars.forEach((radio, idx) => {
                radio.addEventListener('change', function () {
                    // Remove all selected styling
                    starLabels.forEach((label) => label.classList.remove('selected'));
                    // Apply selected to all stars up to and including clicked one
                    for (let i = 0; i <= idx; i++) {
                        starLabels[i].classList.add('selected');
                    }
                });
            });
            // Sync visual state if page loads with a value
            radioStars.forEach(radio => {
                radio.addEventListener('input', syncCheckedStars);
            });
        }
    });
</script>

{% endblock %}
